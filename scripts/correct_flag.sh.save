# List of libraries
libraries=(
  "Lib.F.9793"
  "Lib.F.9795"
  "Lib.G.1893"
  "Lib.G.1894"
  "Lib.G.1895"
  "Lib.G.2515"
  "Lib.G.427"
  "Lib.G.431"
  "Lib.G.432"
  "Lib.J.7660"
  "Lib.J.7678"
  "Lib.G.9961"
  "Lib.H.1879"
  "Lib.H.1880"
  "Lib.H.1881"
  "Lib.H.1882"
  "Lib.J.7626"
  "Lib.J.7627"
  "Lib.J.7638"
)

# Loop over each library
for library in "${libraries[@]}"; do
  bam="${library}_uniqL35MQ25_MDALL_NALL_deam.bam"
  output="${library}_uniqL35MQ25_MDALL_NALL_deam_clean.bam"

  # Process the BAM file
  cd cd "mappedbams/${library}"*/rmdupL35MQ25/target/Mam_div_score_ALL/N_score_ALL/deam/
  
  # Using samtools to filter and process the BAM file
  samtools view -h "$bam" | \
    awk '{if (!($0 ~ /^@/) && and($2,0x200)==512) {printf $1"\t"$2-512; for (i=3; i<=NF; i++) printf "\t"$i; printf "\n"} else {print $0}}' | \
    samtools view -hb > "$output"
done
